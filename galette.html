<html lang="en" ng-app="galette">
    <head>
        <meta charset="utf-8">
        <title>My HTML File</title>
        <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.css">
        <link rel="stylesheet" href="css/app.css">
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.0/angular.js"></script>
        <style>
            .feve {opacity: 0.3;}
            .slice:not(.first) {opacity: 0.3;}
            .hid {visibility: hidden;}
        </style>
    </head>
    <body ng-controller="Galette">
        
        <input ng-model="nSlices" type="range" min="2" max="20" ng-change="update()"/>
        <input ng-model="r" type="range" min="0.01" max="0.5" step="0.01" ng-change="update()"/>
        <input ng-model="marginRatio" type="range" min="0.7" max="1" step="0.01"/>
        <span ng-bind="probaOk"> </span>
        
        <svg width="1000" height="1000"
             xmlns:xlink= "http://www.w3.org/1999/xlink">
            <defs>
                <clipPath id="pieSlice">
                    <path d="M 0 0
                             L {{R}} 0
                             A {{R}} {{R}} 0 0 1 {{R*cosD(360 / nSlices)}} {{R*sinD(360 / nSlices)}}
                             Z"/>
                </clipPath>
                <clipPath id="pieSliceInner">
                    <path d="M 0 0
                             L {{R-r}} 0
                             A {{R-r}} {{R-r}} 0 0 1 {{(R-r)*cosD(360 / nSlices)}} {{(R-r)*sinD(360 / nSlices)}}
                             Z"/>
                </clipPath>
            </defs>
            
            <rect class="zoomSlice" x="{{R*scale}}" y="{{R*scale*(1-marginRatio*sinD(30))}}" width="{{R*scale*marginRatio}}" height="{{R*scale*marginRatio*sinD(30)}}" fill="red"/>
            <rect class="zoomRhombus" x="{{R*scale}}" y="{{(R-marginRatio*r)*scale}}" width="{{geom.x*scale*marginRatio}}" height="{{r*scale*marginRatio}}" fill="red"/>

            <image xlink:href="http://2.bp.blogspot.com/_NmFLsOnnU1M/SW5b5Ym4h7I/AAAAAAAADEk/Un7QagXTS0U/s1600/galette.jpg"
                   x="0" y="0" width="{{R*2*scale}}" height="{{R*2*scale}}"/>

                        
            <g transform="scale({{scale}}) translate({{R}}, {{R}}) scale(1, -1) scale({{marginRatio}})"
               stroke-width="{{2/scale}}"
               opacity="0.8">
                <g ng-repeat="a in angles" transform="rotate({{a}})" ng-class="{slice: true, first: $first}">
                    <path d="M 0 0
                             L {{R}} 0
                             A {{R}} {{R}} 0 0 1 {{R*cosD(360 / nSlices)}} {{R*sinD(360 / nSlices)}}
                             Z" stroke="black" fill="#EEEEEE"/>
                    <g clip-path="url(#pieSlice)" fill-opacity="0.4">
                        <path d="M {{R-r}} 0
                                 L {{R}} 0
                                 A {{R}} {{R}} 0 0 1 {{R*cosD(360 / nSlices)}} {{R*sinD(360 / nSlices)}}
                                 L {{(R-r)*cosD(360 / nSlices)}} {{(R-r)*sinD(360 / nSlices)}}
                                 A {{R-r}} {{R-r}} 0 0 0 {{R-r}} {{0}}
                                 Z" stroke="black" fill="red"/>
                    </g>
                    <g clip-path="url(#pieSliceInner)" fill-opacity="0.4" >
                        <rect x="{{nSlices > 2 ? -r : 0}}" y="{{-r}}" width="{{R+2*r}}" height="{{2*r}}" fill="blue"/>
                        <rect transform="rotate({{360 / nSlices}})"
                              x="{{nSlices > 2 ? -r : 0}}" y="{{-r}}" width="{{R+2*r}}" height="{{2*r}}" fill="green"/>
                    </g>
                    <g class="iffirst" ng-if="$first">
                        <g class="feve" transform="rotate({{360/nSlices/2}})"> 
                            <circle cx="{{R-r}}" cy="0" r="{{r}}" fill="yellow" stroke="red" opacity="0.5"/>
                            <g transform="translate({{R-r}}, 0)" notranrformadd=rotate({{-(.5+$index)*360/nSlices}})" opacity="0.75">
                            <path d="M 0 {{-r}} L 0 {{r}} M {{-r}} 0 L {{r}} 0" stroke="white"/>
                        </g>
                    </g>
                    <g class="rectwr">
                        <rect x="0" y="0" width="{{geom.w}}" height="{{r}}" stroke="black" fill="none"/>
                        <text class="w" transform="translate({{geom.w/2}}, 0) scale({{1/scale}}) translate(0, -15) scale(1, -1)">w</text>
                        <text class="r" transform="rotate(90) translate({{r/2}}, 0) scale({{1/scale}}) rotate(-90) translate(-15, -5) scale(1, -1)">r</text>
                    </g>
                    <g class="split">
                        <path d="M 0 0 L {{geom.x}} {{r}}" stroke="#333"/>
                    </g>
                    <g class="upperleft">
                        <path d="M 0 0 L {{geom.x}} {{r}} L 0 {{r}} L 0 0" fill="red"/>
                    </g>
                    <g class="beta">
                        <g class="angle">
                            <path stroke="black" d="M 0 0 L {{geom.w}} {{r}}"/>
                            <path stroke="black" fill="none" transform="scale(.5, .5)"
                                  d="M {{R-r}} 0
                                  A {{R-r}} {{R-r}} 1 0 1 {{geom.w}} {{r}}"/>
                            <text transform="rotate({{geom.beta/PI*180/2}}) translate({{(R-r)/2}}, 0) scale({{1/scale}}) translate(10, -4) scale(.9) scale(1,-1)">Î²</text>
                        </g>
                        <g class="area">
                            <path stroke="none" fill="black" opacity=".3"
                                  d="M 0 0
                                  L {{R-r}} 0
                                  A {{R-r}} {{R-r}} 1 0 1 {{geom.w}} {{r}}
                                  Z"/>
                        </g>
                    </g>
                </g>
            </g>
        </svg>
        <script>
            angular
                .module('galette', [])
                .controller('Galette', ['$scope', function($scope) {
                    $scope.nSlices = 5;
                    $scope.scale = 500;
                    $scope.R = 1;
                    $scope.r = .2;
                    $scope.PI = Math.PI;
                    $scope.marginRatio = 0.92;
                    $scope.angles = [];
                    $scope.cosD = function(d) {return Math.cos(d/180*Math.PI);}
                    $scope.sinD = function(d) {return Math.sin(d/180*Math.PI);}
                    $scope.update = function() {
                        $scope.angles.length = $scope.nSlices;
                        for (var i = 0; i < $scope.nSlices; i++) {
                            var v = i * 360.0 / $scope.nSlices;
                            $scope.angles[i] = v;
                        }
                        /* // old
                        $scope.z = (function(){
                            var theta = 360.0 / $scope.nSlices;
                            var y = $scope.r;
                            var a = $scope.r / $scope.sinD(theta);
                            var x = a * (1 + $scope.cosD(theta));
                            return Math.sqrt(x*x + y*y);
                        })();
                        var rPossible = $scope.R - $scope.r;
                        var rOk = $scope.R - $scope.r - $scope.z;
                        if (rOk < 0) {
                            $scope.probaOk = 0;
                        } else {
                            $scope.probaOk = rOk*rOk / (rPossible*rPossible);
                        }
                        /*/
                        var theta = Math.PI * 2 / $scope.nSlices;
                        var rPossible = $scope.R - $scope.r;
                        var r = $scope.r;
                        var a = $scope.r / Math.sin(theta);
                        var x = a * (1 + Math.cos(theta));
                        var beta = Math.asin(r / rPossible);
                        var w = rPossible * Math.cos(beta);
                        if (w < x) {
                            $scope.probaOk = 0;                            
                        } else {
                            var areaKo = rPossible*rPossible*beta/2 + (w*r)/2 - (x*r)/2;
                            areaKo *= 2;
                            var areaTotal = rPossible*rPossible*theta/2;
                            $scope.probaOk = (areaTotal - areaKo) / areaTotal;
                        }
                        $scope.geom = {
                            x: x,
                            y: r,
                            a: a,
                            beta: beta,
                            theta: theta,
                            w: w
                        };
                        //*/
                        console.log($scope.probaOk);
                    };
                    $scope.update();
                }]);
        </script>
    </body>
</html>
